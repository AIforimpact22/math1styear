{% extends "index.html" %}
{% block page_title %}Assignment 3 — Functions & Relations Team Challenge{% endblock %}

{% block controls %}
<div class="controls" aria-label="Assignment 3 controls">
  <a href="/content/functions.txt" class="btn" target="_blank" rel="noopener">Open Porosity Log Notes</a>
  <button id="btnStart" class="btn">Start Team Assignment</button>
  <button id="btnGrade" class="btn">Check & Grade</button>
  <button id="btnPdf" class="btn" disabled>Generate PDF</button>
</div>
{% endblock %}

{% block content %}
<section class="canvas-card" aria-label="Assignment 3 container">
  <style>
    .assign-wrap { padding: 14px; }
    .id-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
      margin-bottom: 12px;
    }
    .id-card {
      background: #0f141c;
      border: 1px solid #233040;
      border-radius: 12px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .id-card label { color: #cbd7ea; font-size: 13px; }
    .id-card input[type="text"] {
      background: #0d1320;
      border: 1px solid #263243;
      color: #e8f0ff;
      padding: 8px 10px;
      border-radius: 8px;
    }
    .rule-card {
      background: var(--card);
      border: 1px solid #233040;
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 12px;
    }
    .rule-card h3 { margin: 0 0 6px; font-size: 14px; color: #cbd7ea; }
    .rule-card ul { margin: 6px 0 0 18px; color: #d7e6ff; }
    .role-box {
      display: grid;
      gap: 6px;
      margin-top: 8px;
      background: #0d1320;
      border: 1px dashed #2a394e;
      border-radius: 10px;
      padding: 10px;
    }
    .role-box strong { color: #a9c3ff; }
    .q-card {
      background: #0f141c;
      border: 1px solid #233040;
      border-radius: 12px;
      padding: 12px;
      margin-top: 10px;
    }
    .q-card h4 { margin: 0 0 6px; font-size: 14px; color: #cbd7ea; }
    .q-focus { color: #9fb2c7; font-size: 12px; margin-bottom: 6px; }
    .q-text { color: #d7e6ff; white-space: pre-wrap; margin-bottom: 10px; }
    .q-card textarea {
      background: #0d1320;
      border: 1px solid #263243;
      color: #e8f0ff;
      padding: 10px;
      border-radius: 8px;
      width: 100%;
      min-height: 140px;
    }
    .summary-list { margin: 6px 0 0 18px; color: #d7e6ff; }
    .perq { display: grid; gap: 6px; margin-top: 10px; }
    .perq .item {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      border: 1px dashed #2a394e;
      border-radius: 10px;
      padding: 6px 8px;
    }
  </style>

  <div class="assign-wrap">
    <div class="id-grid">
      <div class="id-card">
        <label for="groupName">Group name</label>
        <input type="text" id="groupName" placeholder="Team Porosity" required />
      </div>
      <div class="id-card">
        <label for="studentA">Student A (Data interpreter)</label>
        <input type="text" id="studentA" placeholder="Full name" required />
      </div>
      <div class="id-card">
        <label for="studentB">Student B (Notation lead)</label>
        <input type="text" id="studentB" placeholder="Full name" required />
      </div>
      <div class="id-card">
        <label for="studentC">Student C (Quality reviewer)</label>
        <input type="text" id="studentC" placeholder="Full name" required />
      </div>
    </div>

    <div class="rule-card" id="rolesCard">
      <h3>How to collaborate</h3>
      <p id="rolesHint">Every answer must clearly label Student A, Student B, and Student C. Start each paragraph with the student’s role and contribution.</p>
      <div class="role-box">
        <strong>Extra reminders for every response</strong>
        <ul class="summary-list" id="extraPrompts">
          <li>Mention the domain (depths) and codomain (porosity) with units.</li>
          <li>Use notation such as f: A → B, (z, φ), ∈, ∉, ⊆, ×.</li>
          <li>State how the group handles duplicate or noisy readings.</li>
          <li>Close with Student C’s collaboration sentence.</li>
        </ul>
      </div>
    </div>

    <div id="questionsBox"></div>

    <div class="q-card" id="gradingBox" style="display:none;">
      <h4>Grading</h4>
      <div class="score">
        <span id="scoreText">Score: 0%</span>
        <div class="bar"><div id="scoreFill" class="fill"></div></div>
        <span id="passPill" class="pill">—</span>
      </div>
      <div class="perq" id="perQuestion"></div>
      <div class="rule-card" style="margin-top:10px;">
        <h3>Summary</h3>
        <div id="summaryText" class="q-text">—</div>
      </div>
      <div class="rule-card" style="margin-top:10px;">
        <strong>Submission:</strong> After generating the PDF, upload it to the University system as your group’s Assignment 3 submission.
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const btnStart = $("btnStart");
  const btnGrade = $("btnGrade");
  const btnPdf   = $("btnPdf");

  const questionsBox = $("questionsBox");
  const gradingBox = $("gradingBox");
  const scoreText = $("scoreText");
  const scoreFill = $("scoreFill");
  const passPill  = $("passPill");
  const perQuestion = $("perQuestion");
  const summaryText = $("summaryText");
  const rolesHint = $("rolesHint");
  const extraPrompts = $("extraPrompts");

  let currentQuestions = [];
  let gradingResult = null;

  const clean = (value) => (value || "").trim();

  const escapeHtml = (s) => (s || "").replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

  function groupKey(qid){
    const group = clean($("groupName").value);
    const a = clean($("studentA").value);
    const b = clean($("studentB").value);
    const c = clean($("studentC").value);
    return `assign3:${group}:${a}:${b}:${c}:${qid}`;
  }

  function renderExtra(list){
    extraPrompts.innerHTML = "";
    (list || []).forEach((item) => {
      const li = document.createElement("li");
      li.textContent = item;
      extraPrompts.appendChild(li);
    });
  }

  function renderQuestions(list){
    questionsBox.innerHTML = "";
    currentQuestions = list;
    list.forEach((q) => {
      const card = document.createElement("div");
      card.className = "q-card";
      card.innerHTML = `
        <h4>${q.id}</h4>
        <div class="q-focus">${escapeHtml(q.focus || "")}</div>
        <div class="q-text">${escapeHtml(q.text)}</div>
        <textarea id="ans_${q.id}" placeholder="Student A: …\nStudent B: …\nStudent C: …"></textarea>
      `;
      questionsBox.appendChild(card);
    });
    list.forEach((q) => {
      const key = groupKey(q.id);
      const saved = localStorage.getItem(key);
      if (saved) {
        const ta = document.getElementById(`ans_${q.id}`);
        if (ta) ta.value = saved;
      }
    });
    list.forEach((q) => {
      const ta = document.getElementById(`ans_${q.id}`);
      if (!ta) return;
      ta.addEventListener("input", () => {
        localStorage.setItem(groupKey(q.id), ta.value);
      });
    });
  }

  function collectAnswers(){
    return currentQuestions.map((q) => ({
      id: q.id,
      question: q.text,
      answer: $("ans_" + q.id)?.value || "",
    }));
  }

  btnStart.addEventListener("click", async () => {
    const group = clean($("groupName").value);
    const a = clean($("studentA").value);
    const b = clean($("studentB").value);
    const c = clean($("studentC").value);
    if (!group){ alert("Please enter a group name."); return; }
    if (!a || !b || !c){ alert("Please enter all three student names."); return; }

    btnStart.disabled = true;
    btnStart.textContent = "Loading…";
    try {
      const resp = await fetch("/assignment-three/api/generate", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ group, studentA: a, studentB: b, studentC: c })
      });
      if (!resp.ok){
        const err = await resp.json().catch(() => ({error: "Generation failed."}));
        throw new Error(err.error || "Generation failed.");
      }
      const data = await resp.json();
      rolesHint.textContent = data.roles || rolesHint.textContent;
      renderExtra(data.extra || []);
      renderQuestions(data.questions || []);
      gradingBox.style.display = "none";
      scoreText.textContent = "Score: 0%";
      scoreFill.style.width = "0%";
      passPill.textContent = "—";
      btnPdf.disabled = true;
    } catch (err){
      alert(err.message || "Unable to generate questions. Try again.");
    } finally {
      btnStart.disabled = false;
      btnStart.textContent = "Start Team Assignment";
    }
  });

  btnGrade.addEventListener("click", async () => {
    if (!currentQuestions.length){ alert("Generate the questions first."); return; }
    const group = clean($("groupName").value);
    const a = clean($("studentA").value);
    const b = clean($("studentB").value);
    const c = clean($("studentC").value);

    btnGrade.disabled = true;
    btnGrade.textContent = "Grading…";
    try {
      const qa = collectAnswers();
      const resp = await fetch("/assignment-three/api/grade", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ group, studentA: a, studentB: b, studentC: c, qa })
      });
      const data = await resp.json();
      if (!resp.ok){
        throw new Error(data.error || "Grading failed.");
      }
      gradingResult = data;
      gradingBox.style.display = "block";
      scoreText.textContent = `Score: ${data.overall_pct || 0}%`;
      scoreFill.style.width = `${Math.min(100, data.overall_pct || 0)}%`;
      passPill.textContent = data.pass ? "Pass" : "Keep working";
      passPill.className = `pill ${data.pass ? 'good' : 'bad'}`;
      summaryText.textContent = data.summary || "—";
      perQuestion.innerHTML = "";
      (data.per_question || []).forEach((item) => {
        const row = document.createElement("div");
        row.className = "item";
        row.innerHTML = `<span><strong>${item.id}</strong> — ${escapeHtml(item.feedback || '')}</span><span>${item.score}/10</span>`;
        perQuestion.appendChild(row);
      });
      btnPdf.disabled = !(data.pass);
    } catch (err){
      alert(err.message || "Grading failed. Try again.");
    } finally {
      btnGrade.disabled = false;
      btnGrade.textContent = "Check & Grade";
    }
  });

  btnPdf.addEventListener("click", () => {
    if (!gradingResult || !gradingResult.pass){
      alert("Reach the passing score before generating the PDF.");
      return;
    }
    window.print();
  });
})();
</script>
{% endblock %}
