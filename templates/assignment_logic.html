<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Logic — Lecture 3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b0e14; --panel:#111827; --ink:#e5e7eb; --muted:#9ca3af; --accent:#8b5cf6; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --border:#374151; }
    * { box-sizing:border-box; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg); color:var(--ink); margin:0; }
    header { padding:20px; border-bottom:1px solid var(--border); background:linear-gradient(180deg, rgba(139,92,246,.15), transparent); }
    h1 { margin:0; font-size:1.35rem; }
    main { max-width: 980px; margin: 20px auto 120px; padding: 0 16px; }
    .card { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
    label { font-size:.95rem; color:var(--muted); }
    input[type=text] { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#0e1525; color:var(--ink); }
    textarea { width:100%; min-height:110px; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#0e1525; color:var(--ink); }
    button { background:var(--accent); color:#fff; border:none; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer; }
    button.secondary { background:transparent; color:var(--ink); border:1px solid var(--border); }
    .small { font-size:.9rem; color:var(--muted); }
    .title { margin:8px 0; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; border:1px solid var(--border); background:#0d1323; }
    .status { padding:6px 10px; border-radius:999px; font-weight:600; }
    .ok { background:rgba(16,185,129,.15); color:#34d399; }
    .bad { background:rgba(239,68,68,.15); color:#f87171; }
    .warn { background:rgba(245,158,11,.15); color:#fbbf24; }
    .hr { height:1px; background:var(--border); margin:14px 0; }
    .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
    .footer-actions { position:fixed; inset:auto 0 0 0; background:linear-gradient(180deg, transparent, rgba(17,24,39,.92)); padding:16px; border-top:1px solid var(--border); }
    .muted { color:var(--muted); }
    .grid2 { display:grid; grid-template-columns: 1fr; gap:12px; }
    @media print {
      .footer-actions, #loadCard { display:none !important; }
      body { background:#fff; color:#000; }
      .card { border:1px solid #ddd; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Assignment / Feladatlap — Lecture 3</h1>
    <div class="small">Use only: <span class="mono">,</span> (NOT), <span class="mono">`</span> (AND), <span class="mono">~</span> (OR). / Csak ezeket: <span class="mono">,</span> (NEM), <span class="mono">`</span> (ÉS), <span class="mono">~</span> (VAGY).</div>
  </header>

  <main>
    <div id="loadCard" class="card">
      <div class="row">
        <div style="flex:1 1 260px;">
          <label>Full name</label>
          <input id="name" type="text" placeholder="Student name (optional)" />
        </div>
        <div style="flex:0 0 180px;">
          <label>Neptun</label>
          <input id="neptun" type="text" placeholder="ABC123" />
        </div>
        <div>
          <button id="loadBtn">Load assignment</button>
        </div>
      </div>
      <div class="hr"></div>
      <div id="opsHint" class="small muted"></div>
    </div>

    <div id="assignment"></div>

    <div class="footer-actions">
      <div class="row" style="justify-content: space-between; align-items:center;">
        <div>
          <span id="status" class="status warn">Not graded</span>
        </div>
        <div class="row">
          <button class="secondary" id="printBtn" title="Download PDF">Download PDF</button>
          <button class="secondary" id="resetBtn">Reset</button>
          <button id="submitBtn">Submit / Grade</button>
        </div>
      </div>
    </div>
  </main>

<script>
let manifest = null;

const E = (tag, attrs={}, ...children) => {
  const el = document.createElement(tag);
  Object.entries(attrs || {}).forEach(([k,v])=>{
    if (k === 'class') el.className = v;
    else if (k === 'html') el.innerHTML = v;
    else el.setAttribute(k, v);
  });
  for (const c of children) {
    if (c == null) continue;
    if (typeof c === 'string') el.appendChild(document.createTextNode(c));
    else el.appendChild(c);
  }
  return el;
};

function renderAssignment(m) {
  const wrap = document.getElementById('assignment');
  wrap.innerHTML = '';
  document.getElementById('opsHint').textContent = m.allowed_ops || '';

  const info = E('div', {class:'small muted'},
    'Answer in English or Hungarian. One input per question. / Válasz angolul vagy magyarul. Feladatonként egy beviteli mező.');
  wrap.appendChild(E('div', {class:'card'}, info));

  (m.items || []).forEach(item => {
    const card = E('div', {class:'card'});
    card.appendChild(E('div', {class:'title'}, E('strong', {}, item.title || item.id)));
    card.appendChild(E('div', {class:'small'}, item.en || ''));
    card.appendChild(E('div', {class:'small'}, item.hu || ''));
    card.appendChild(E('div', {class:'hr'}));
    const ta = E('textarea', {'data-id': item.id, placeholder:'Type your answer (EN or HU) / Írd be a választ (EN vagy HU)'});
    card.appendChild(ta);
    wrap.appendChild(card);
  });
}

function collectAnswers() {
  const answers = [];
  document.querySelectorAll('textarea[data-id]').forEach(t => {
    answers.push({ id: t.dataset.id, text: t.value });
  });
  return answers;
}

async function postJSON(url, payload) {
  const res = await fetch(url, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.json();
}

document.getElementById('loadBtn').addEventListener('click', async ()=>{
  const name = document.getElementById('name').value.trim();
  const neptun = document.getElementById('neptun').value.trim();
  try {
    manifest = await postJSON('/logic-assignment/api/generate', { name, neptun });
    renderAssignment(manifest);
    const st = document.getElementById('status');
    st.textContent = 'Loaded — not graded';
    st.className = 'status warn';
  } catch (e) {
    alert('Failed to load assignment.');
  }
});

document.getElementById('submitBtn').addEventListener('click', async ()=>{
  try {
    if (!manifest) {
      alert('Please load the assignment first.');
      return;
    }
    const answers = collectAnswers();
    const result = await postJSON('/logic-assignment/api/grade', { answers });

    // Results card
    const fb = E('div', {class:'card', id:'resultsCard'});
    fb.appendChild(E('h3', {}, 'Results / Eredmény'));
    (result.per_item || []).forEach(row => {
      const chip = E('span', {class:'pill'},
        E('span', {class:'mono'}, row.id),
        E('span', {class: row.score>=8 ? 'ok' : row.score>=6 ? 'warn' : 'bad' }, `${row.score}/10`));
      fb.appendChild(E('div', {}, chip));
      fb.appendChild(E('div', {class:'small', style:'margin:6px 0;'}, row.feedback_en || ''));
      fb.appendChild(E('div', {class:'small muted', style:'margin:0 0 12px;'}, row.feedback_hu || ''));
    });
    fb.appendChild(E('div', {class:'hr'}));
    fb.appendChild(E('div', {}, `Overall: ${result.overall_pct}% — ${result.pass ? 'PASS' : 'REVISE'}`));
    if (result.summary) {
      fb.appendChild(E('div', {class:'small', style:'margin-top:6px;'}, result.summary.en || ''));
      fb.appendChild(E('div', {class:'small muted'}, result.summary.hu || ''));
    }

    // Insert/replace at top
    const assignment = document.getElementById('assignment');
    const old = document.getElementById('resultsCard');
    if (old) old.remove();
    assignment.insertBefore(fb, assignment.firstChild);

    const st = document.getElementById('status');
    st.textContent = `Graded: ${result.overall_pct}%`;
    st.className = 'status ' + (result.overall_pct>=70 ? 'ok' : 'bad');
  } catch (e) {
    alert('Failed to grade.');
  }
});

document.getElementById('resetBtn').addEventListener('click', ()=>{
  if (!manifest) return;
  renderAssignment(manifest);
  const st = document.getElementById('status');
  st.textContent = 'Reset — not graded';
  st.className = 'status warn';
});

document.getElementById('printBtn').addEventListener('click', ()=>{
  // Simple, robust client-side PDF via browser print
  window.print();
});
</script>
</body>
</html>
